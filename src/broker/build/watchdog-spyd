#!/bin/sh

export ZK_SERVER=`grep mistd.zookeeper= /usr/share/mist/etc/mistd.properties | cut -d '=' -f 2`

pid=`ps -C java -o pid,args |grep com.trendmicro.mist.cmd.TmeSpy | sed -e 's/^ *//' | cut -d ' ' -f 1`
if [ -z "$pid" ]; then
    echo "tme-spyd not running, start it"
    /etc/init.d/tme-spyd start
    SMTP_SERVER=`zk-get -p /tme2/global/mail_smtp`
    if [ $? -eq 1 ] || [ "$SMTP_SERVER" = "" ]; then
        echo can not get SMTP server from /tme2/global/mail_smtp
        exit 1
    fi
    mail_to=`zk-get -p /tme2/global/mail_alert`
    if [ $? -eq 1 ] || [ "$mail_to" = "" ]; then
        echo can not retrieve mail alert recipients from /tme2/global/mail_alert
        exit 1
    fi
    mail_subject='[tme-spyd] restarted'
    mail_body="<b>Alert!</b><p>tme-spyd on `hostname -f` (`hostname -i`) has been restarted.<br>"
    echo $mail_body | spn-mail -m $SMTP_SERVER -t "$mail_to" -s "$mail_subject"
fi
exit 0
