#!/bin/sh

if [ $# -eq 1 ]; then
    if [ $1 == 'dead' ]; then
        mail_subject='[tme-brokerd] broker dead'
        mail_body="<b>Alert!</b><p>>tme-brokerd on `hostname -i` is dead.<br>"
    elif [ $1 == 'restart' ]; then
        mail_subject='[tme-brokerd] broker restarted'
        mail_body="<b>Notification!</b><p>>tme-brokerd on `hostname -i` is recovered.<br>"
    else
        exit 1
    fi
elif [ $# -eq 2 ]; then
    if [ $1 == 'loading' ]; then
        mail_subject='[tme-brokerd] broker overuse'
        mail_body="<b>Alert!</b><p>>tme-brokerd on `hostname -i` is in high loading($2).<br>"
    else
        exit 1
    fi
elif [ $# -eq 3 ]; then
    if [ $1 == 'custom' ]; then
        mail_subject=$2
        mail_body=$3
    else
        exit 1
    fi
else
    exit 1
fi

export ZK_SERVER=`grep mistd.zookeeper= /usr/share/mist/etc/mistd.properties | cut -d '=' -f 2`

SMTP_SERVER=`zk-get -p /tme2/global/mail_smtp`
if [ $? -eq 1 ] || [ "$SMTP_SERVER" = "" ]; then
    echo can not get SMTP server from /tme2/global/mail_smtp
    exit 1
fi
mail_to=`zk-get -p /tme2/global/mail_alert`
if [ $? -eq 1 ] || [ "$mail_to" = "" ]; then
   echo can not retrieve mail alert recipients from /tme2/global/mail_alert
   exit 1
fi

echo $mail_body | spn-mail -m $SMTP_SERVER -t "$mail_to" -s "$mail_subject"

exit 0
