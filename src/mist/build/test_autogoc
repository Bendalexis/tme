#!/bin/sh

EXCHANGE_NAME='TEST'
MSG_CNT=10

echo "################################################################################"
echo "  MIST AutoGOC Test "
echo "  - Transmit $MSG_CNT messages through exchange $EXCHANGE_NAME"
echo "################################################################################"

zkserver=`sed -e '/zookeeper=/!d ; s/.*=//g' /usr/share/mist/etc/mistd.properties`
zk-get --server=$zkserver --path=/tme2/global/goc_server >/dev/null 2>/dev/null
if [[ "$?" == "1" ]]; then
    echo "GOC Server not configured!"
    exit 1
fi

echo "exchange -g $EXCHANGE_NAME" | tme-console >/dev/null 2>/dev/null

SEND_DATA='/tmp/test_mistd.send'
RECV_DATA='/tmp/test_mistd.recv'

echo create source
SOURCE_ID=`mist-session`
mist-source $SOURCE_ID -m $EXCHANGE_NAME 

echo create sink
SINK_ID=`mist-session`
mist-sink $SINK_ID -m $EXCHANGE_NAME 

echo sending in background
mist-line-gen -s 1000000 -c $MSG_CNT | mist-encode -l -w $EXCHANGE_NAME | mist-sink $SINK_ID -a -c > $SEND_DATA &

echo receiving $MSG_CNT messages
mist-source $SOURCE_ID -a --limit-count=$MSG_CNT | mist-decode -c > $RECV_DATA

echo -n "verify result ... "
diff $RECV_DATA $SEND_DATA
if [ $? -eq 0 ]; then
    echo SUCCESS
    ret_code=0
    rm $RECV_DATA $SEND_DATA
else
    echo FAILED
    ret_code=1
    cat $RECV_DATA
    cat $SEND_DATA
fi

mist-session -d $SOURCE_ID > /dev/null
mist-session -d $SINK_ID > /dev/null

echo "exchange -G $EXCHANGE_NAME" | tme-console >/dev/null 2>/dev/null

exit $ret_code 
