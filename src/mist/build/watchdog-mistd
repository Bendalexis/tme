#!/bin/sh

if [ `whoami` != "root" ]; then 
    echo requires root permission
    exit 1;
fi

export ZK_SERVER=`grep mistd.zookeeper= /usr/share/mist/etc/mistd.properties | cut -d '=' -f 2`

restart_mist() {
    /etc/init.d/mistd restart
    SMTP_SERVER=`zk-get -p /tme2/global/mail_smtp`
    if [ $? -eq 1 ] || [ "$SMTP_SERVER" = "" ]; then
        echo can not get SMTP server from /tme2/global/mail_smtp
        exit 1
    fi
    mail_to=`zk-get -p /tme2/global/mail_alert`
    if [ $? -eq 1 ] || [ "$mail_to" = "" ]; then
        echo can not retrieve mail alert recipients from /tme2/global/mail_alert
        exit 1
    fi
    mail_subject='[mistd] restarted'
    mail_body="<b>Alert!</b><p>mistd on `hostname -f` (`hostname -i`) has been restarted.<br>"
    echo $mail_body | spn-mail -m $SMTP_SERVER -t "$mail_to" -s "$mail_subject"
}

pid=`ps -C java -o pid,args | grep com.trendmicro.mist.Daemon | sed -e 's/^ *//' | cut -d ' ' -f 1`
if [ -z "$pid" ]; then
    echo "mistd process not exist, restart it"
    restart_mist
else
    ping_file=/var/run/tme/mist-session.ping
    mist-session -p hello_mist > $ping_file &
    mypid=$!
    for i in {1..50}; do
        ps -p $mypid > /dev/null
        running=$?
        if [ $running -eq 1 ]; then
            break
        fi
        sleep 0.1
    done
    if [ $running -eq 0 ]; then
        kill -9 $mypid
        echo "ping mistd blocked, restart it"
        restart_mist
    else
        content=`cat $ping_file`
        if [ "$content" != "tsim_olleh" ]; then 
            echo "mistd responding error, restart it"
            restart_mist
        fi
    fi    
fi

exit 0
